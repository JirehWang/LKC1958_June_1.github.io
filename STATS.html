<style>
  /* çµ±è¨ˆé é¢å°ˆç”¨æ¨£å¼ */
  .stats-container {
    padding: 10px;
    background-color: #fff;
    border-radius: 8px;
  }
  .progress {
    background-color: #e9ecef;
    border-radius: 5px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,.1);
  }
  .mode-switch-btn {
    width: 50%;
    font-weight: bold;
  }
  .stat-card {
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border: 1px solid #dee2e6;
  }
</style>

<div class="stats-container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0 text-dark">ğŸ“Š èšæœƒå‡ºå¸­çµ±è¨ˆ</h4>
  </div>
  
  <div class="bg-light p-3 rounded border mb-3">
    <div class="btn-group w-100 mb-3" role="group">
      <input type="radio" class="btn-check" name="statMode" id="modeRange" autocomplete="off" checked onclick="toggleStatMode('range')">
      <label class="btn btn-outline-primary mode-switch-btn" for="modeRange">ğŸ“… å€é–“çµ±è¨ˆ</label>

      <input type="radio" class="btn-check" name="statMode" id="modeSingle" autocomplete="off" onclick="toggleStatMode('single')">
      <label class="btn btn-outline-primary mode-switch-btn" for="modeSingle">ğŸ“† å–®æ—¥æª¢è¦–</label>
    </div>

    <div class="row g-2 align-items-end" id="rangeInputArea">
      <div class="col-6">
        <label class="small text-muted fw-bold">é–‹å§‹æ—¥æœŸ</label>
        <input type="date" id="statsStart" class="form-control form-control-sm">
      </div>
      <div class="col-6">
        <label class="small text-muted fw-bold">çµæŸæ—¥æœŸ</label>
        <input type="date" id="statsEnd" class="form-control form-control-sm">
      </div>
      <div class="col-12 mt-2">
         <label class="small text-muted fw-bold">å‡ºå¸­ç‡é–€æª» (%)</label>
         <input type="number" id="threshold" class="form-control form-control-sm" value="100" min="0" max="100" placeholder="é¡¯ç¤ºä½æ–¼æ­¤%çš„äºº">
      </div>
    </div>

    <div class="row g-2 align-items-end" id="singleInputArea" style="display: none;">
      <div class="col-12">
        <label class="small text-muted fw-bold">é¸æ“‡æ—¥æœŸ</label>
        <input type="date" id="statsSingleDate" class="form-control form-control-sm">
      </div>
    </div>

    <div class="row g-2 mt-3">
      <div class="col-6">
        <button class="btn btn-primary btn-sm w-100 fw-bold shadow-sm" onclick="fetchStatsData()">
          ğŸ” é–‹å§‹æŸ¥è©¢
        </button>
      </div>
      <div class="col-6">
        <button class="btn btn-success btn-sm w-100 fw-bold shadow-sm" onclick="exportToCSV()">
          ğŸ“¥ åŒ¯å‡º Excel
        </button>
      </div>
    </div>
  </div>

  <ul class="nav nav-pills nav-fill mb-3 shadow-sm rounded border p-1 bg-white" id="statsTabList">
    <li class="nav-item"><a class="nav-link active" onclick="changeStatsTab(this, 'å°èª')">å°èª</a></li>
    <li class="nav-item"><a class="nav-link" onclick="changeStatsTab(this, 'è¯èª')">è¯èª</a></li>
    <li class="nav-item"><a class="nav-link" onclick="changeStatsTab(this, 'è¯åˆ')">è¯åˆ</a></li>
    <li class="nav-item"><a class="nav-link fw-bold text-dark" onclick="changeStatsTab(this, 'åˆè¨ˆ')">åˆè¨ˆ</a></li>
  </ul>

  <div class="row mb-3 text-center g-2">
    <div class="col-4">
      <div class="stat-card bg-white">
        <div class="small text-muted fw-bold mb-1" id="lblMainStat">ç¸½å ´æ¬¡</div>
        <div class="h4 mb-0 fw-bold text-primary" id="valMainStat">0</div>
      </div>
    </div>
    
    <div class="col-4">
      <div class="stat-card" style="background-color: #f1f8f5; border-color: #badbcc;">
        <div class="small text-muted fw-bold mb-1 text-success">ğŸ“‹ åå–®å‡ºå¸­</div>
        <div class="h5 mb-1 fw-bold text-dark" id="valMemberStat">0</div>
        <div class="d-flex justify-content-center gap-2" style="font-size: 0.75rem;">
          <span class="text-primary fw-bold">ğŸ‘¦ <span id="valMemberMale">0</span></span>
          <span class="text-danger fw-bold">ğŸ‘§ <span id="valMemberFemale">0</span></span>
        </div>
      </div>
    </div>
    
    <div class="col-4">
      <div class="stat-card" style="background-color: #fffdf2; border-color: #ffecb5;">
        <div class="small text-muted fw-bold mb-1" style="color: #997404;">ğŸ‘¶ æ–°æœ‹å‹</div>
        <div class="h5 mb-1 fw-bold text-dark" id="valNewFriendStat">0</div>
        <div class="d-flex justify-content-center gap-2" style="font-size: 0.75rem;">
          <span class="text-primary fw-bold">ğŸ‘¦ <span id="valNfMale">0</span></span>
          <span class="text-danger fw-bold">ğŸ‘§ <span id="valNfFemale">0</span></span>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive border rounded" style="min-height: 500px; background: white;">
    <table class="table table-sm table-hover align-middle mb-0">
      <thead class="table-light sticky-top" style="z-index: 10; top: 0;"> 
        <tr class="small text-muted" id="tableHeaderRow">
          <th class="ps-3">å§“å</th>
          <th class="text-center">æ€§åˆ¥</th>
          <th class="text-center">æ¬¡æ•¸</th>
          <th style="width: 35%;">å‡ºå¸­ç‡</th>
        </tr>
      </thead>
      <tbody id="statsTableBody" class="small">
        <tr><td colspan="4" class="text-center p-5 text-muted">è«‹é¸æ“‡æ—¥æœŸä¸¦é»æ“Šã€Œé–‹å§‹æŸ¥è©¢ã€</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  let currentStatsData = null; 
  let activeTab = 'å°èª';
  let currentMode = 'range'; 

  window.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    const toLocalISO = (d) => {
        const offset = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() - offset).toISOString().split('T')[0];
    };

    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    document.getElementById('statsStart').value = toLocalISO(firstDay);
    document.getElementById('statsEnd').value = toLocalISO(now);
    document.getElementById('statsSingleDate').value = toLocalISO(now);
  });

  function toggleStatMode(mode) {
    currentMode = mode;
    if (mode === 'range') {
      document.getElementById('rangeInputArea').style.display = 'flex';
      document.getElementById('singleInputArea').style.display = 'none';
    } else {
      document.getElementById('rangeInputArea').style.display = 'none';
      document.getElementById('singleInputArea').style.display = 'flex';
    }
    document.getElementById('statsTableBody').innerHTML = '<tr><td colspan="4" class="text-center p-5 text-muted">æ¨¡å¼å·²åˆ‡æ›ï¼Œè«‹é‡æ–°æŸ¥è©¢</td></tr>';
    
    // æ¸…ç©ºæ‰€æœ‰å¡ç‰‡æ•¸å€¼
    ['valMainStat', 'valMemberStat', 'valMemberMale', 'valMemberFemale', 'valNewFriendStat', 'valNfMale', 'valNfFemale'].forEach(id => {
       document.getElementById(id).innerText = '0';
    });
  }

  function fetchStatsData() {
    const req = { type: activeTab, mode: currentMode };

    if (currentMode === 'range') {
      req.start = document.getElementById('statsStart').value;
      req.end = document.getElementById('statsEnd').value;
      if (!req.start || !req.end) return alert("è«‹é¸æ“‡èµ·è¨–æ—¥æœŸ");
    } else {
      req.date = document.getElementById('statsSingleDate').value;
      if (!req.date) return alert("è«‹é¸æ“‡æ—¥æœŸ");
    }

    const tbody = document.getElementById('statsTableBody');
    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-5"><div class="spinner-border text-primary mb-2"></div><div class="text-muted">æ­£åœ¨åˆ†ææ•¸æ“š...</div></td></tr>';
    
    const btn = document.querySelector('button[onclick="fetchStatsData()"]');
    if(btn) btn.disabled = true;

    google.script.run
      .withFailureHandler(function(err) {
         console.error("æŸ¥è©¢å¤±æ•—:", err);
         alert("âŒ æŸ¥è©¢å¤±æ•—: " + err.message);
         tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-danger">éŒ¯èª¤<br><small>${err.message}</small></td></tr>`;
         if(btn) btn.disabled = false;
      })
      .withSuccessHandler(function(data) {
        currentStatsData = data;
        renderStatsTable(data);
        if(btn) btn.disabled = false;
      })
      .getAttendanceStats(req);
  }

  function changeStatsTab(el, type) {
    activeTab = type;
    document.querySelectorAll('#statsTabList .nav-link').forEach(nav => nav.classList.remove('active'));
    el.classList.add('active');
    fetchStatsData();
  }

  function renderStatsTable(data) {
    if (!data) return;

    // --- å–å¾—å¾Œç«¯å›å‚³çš„æ•¸å€¼ ---
    const nfMale = Number(data.nfMale || 0);
    const nfFemale = Number(data.nfFemale || 0);
    const presentMale = Number(data.presentMale || 0);
    const presentFemale = Number(data.presentFemale || 0);
    
    const presentCount = Number(data.presentCount || 0);
    const avgCount = Number(data.avgCount || 0);

    // å¡«å…¥æ–°æœ‹å‹å¡ç‰‡
    document.getElementById('valNewFriendStat').innerText = nfMale + nfFemale;
    document.getElementById('valNfMale').innerText = nfMale;
    document.getElementById('valNfFemale').innerText = nfFemale;

    // å¡«å…¥åå–®å‡ºå¸­å¡ç‰‡
    document.getElementById('valMemberStat').innerText = presentCount;
    document.getElementById('valMemberMale').innerText = presentMale;
    document.getElementById('valMemberFemale').innerText = presentFemale;

    // å¡«å…¥ç¸½è¨ˆå¡ç‰‡
    if (currentMode === 'range') {
      document.getElementById('lblMainStat').innerText = "å¹³å‡ç¸½äººæ•¸"; 
      document.getElementById('valMainStat').innerText = avgCount; 
    } else {
      document.getElementById('lblMainStat').innerText = "ç¸½å‡ºå¸­äººæ•¸";
      document.getElementById('valMainStat').innerText = presentCount + (nfMale + nfFemale);
    }

    // --- ç”¢ç”Ÿè¡¨é ­èˆ‡è©³ç´°åˆ—è¡¨ ---
    const theadRow = document.getElementById('tableHeaderRow');
    if (currentMode === 'range') {
      theadRow.innerHTML = `
        <th class="ps-3">å§“å</th>
        <th class="text-center">æ€§åˆ¥</th>
        <th class="text-center">æ¬¡æ•¸</th>
        <th style="width: 35%;">å‡ºå¸­ç‡</th>
      `;
    } else {
      theadRow.innerHTML = `
        <th class="ps-3">å§“å</th>
        <th class="text-center">æ€§åˆ¥</th>
        <th class="text-center">ç‹€æ…‹</th>
        <th class="text-center">å‚™è¨»</th>
      `;
    }

    const tbody = document.getElementById('statsTableBody');
    let html = '';
    const thresholdInput = document.getElementById('threshold').value;
    const threshold = thresholdInput === "" ? 100 : parseInt(thresholdInput);

    if (data.details && data.details.length > 0) {
      data.details.forEach(row => {
        const gender = row.gender || '-';
        const genderColor = gender === 'ç”·' ? '#0d6efd' : (gender === 'å¥³' ? '#dc3545' : '#6c757d');

        if (currentMode === 'range') {
          if (row.rate <= threshold) {
            let barClass = 'bg-danger';
            if (row.rate > 80) barClass = 'bg-success';
            else if (row.rate > 50) barClass = 'bg-primary';
            else if (row.rate > 30) barClass = 'bg-warning';

            html += `
              <tr>
                <td class="ps-3 fw-bold">${row.name}</td>
                <td class="text-center fw-bold" style="color:${genderColor}">${gender}</td>
                <td class="text-center fw-bold text-dark">${row.count}</td>
                <td class="pe-2">
                  <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1" style="height: 10px;">
                      <div class="progress-bar ${barClass}" style="width: ${row.rate}%"></div>
                    </div>
                    <span class="ms-2 small text-muted" style="width: 35px; text-align: right;">${row.rate}%</span>
                  </div>
                </td>
              </tr>`;
          }
        } else {
          const statusBadge = row.attended ? 
            `<span class="badge bg-success bg-opacity-10 text-success border border-success px-3">å·²å‡ºå¸­</span>` : 
            `<span class="badge bg-light text-muted border px-3">ç¼ºå¸­</span>`;
            
          const nameStyle = row.attended ? "fw-bold text-dark" : "text-muted";
          
          html += `
            <tr>
              <td class="ps-3 ${nameStyle}">${row.name}</td>
              <td class="text-center fw-bold" style="color:${genderColor}">${gender}</td>
              <td class="text-center">${statusBadge}</td>
              <td class="text-center small text-muted">-</td>
            </tr>`;
        }
      });
    } else {
      html = '<tr><td colspan="4" class="text-center p-4 text-muted">ç„¡è³‡æ–™</td></tr>';
    }
    tbody.innerHTML = html;
  }

  // 6. åŒ¯å‡º CSV (âœ… åŒ…å«åå–®èˆ‡æ–°æœ‹å‹çš„ç”·å¥³ç´°é …)
  function exportToCSV() {
    if (!currentStatsData || !currentStatsData.details) { alert("è«‹å…ˆé€²è¡ŒæŸ¥è©¢"); return; }

    let csvRows = [];
    const nfMale = Number(currentStatsData.nfMale || 0);
    const nfFemale = Number(currentStatsData.nfFemale || 0);
    const presentMale = Number(currentStatsData.presentMale || 0);
    const presentFemale = Number(currentStatsData.presentFemale || 0);
    
    if (currentMode === 'range') {
        csvRows.push(['', 'çµ±è¨ˆæ‘˜è¦']);
        csvRows.push(['å¹³å‡åå–®å‡ºå¸­(ç”·)', presentMale, 'å¹³å‡åå–®å‡ºå¸­(å¥³)', presentFemale]);
        csvRows.push(['æœŸé–“æ–°æœ‹å‹(ç”·)', nfMale, 'æœŸé–“æ–°æœ‹å‹(å¥³)', nfFemale]);
        csvRows.push([]);
        csvRows.push(['å§“å', 'æ€§åˆ¥', 'å‡ºå¸­æ¬¡æ•¸', 'å‡ºå¸­ç‡(%)']);
        currentStatsData.details.forEach(row => {
            csvRows.push([row.name, row.gender, row.count, row.rate + '%']);
        });
    } else {
        const date = document.getElementById('statsSingleDate').value;
        csvRows.push(['æ—¥æœŸ', date]);
        csvRows.push(['åå–®å‡ºå¸­(ç”·)', presentMale, 'åå–®å‡ºå¸­(å¥³)', presentFemale]);
        csvRows.push(['æ–°æœ‹å‹(ç”·)', nfMale, 'æ–°æœ‹å‹(å¥³)', nfFemale]);
        csvRows.push([]); 
        csvRows.push(['å§“å', 'æ€§åˆ¥', 'å‡ºå¸­ç‹€æ…‹']);
        currentStatsData.details.forEach(row => {
            csvRows.push([row.name, row.gender, row.attended ? 'å‡ºå¸­' : 'ç¼ºå¸­']);
        });
    }

    const csvString = "\uFEFF" + csvRows.map(row => row.join(",")).join("\n");
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    
    const fileName = currentMode === 'range' ? 
        `å‡ºå¸­çµ±è¨ˆ_å€é–“_${activeTab}.csv` : 
        `å‡ºå¸­åå–®_${document.getElementById('statsSingleDate').value}_${activeTab}.csv`;

    link.setAttribute("href", url);
    link.setAttribute("download", fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>
