<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>â›ª æ•™æœƒç®¡ç†ç³»çµ± - GitHub æ——è‰¦ç‰ˆ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    /* --- å…¨åŸŸæ¨£å¼ --- */
    body { background-color: #f4f7f6; font-family: -apple-system, "Microsoft JhengHei", sans-serif; }
    .app-container { width: 100%; padding: 15px; margin: 0 auto; max-width: 600px; }
    .nav-card { cursor: pointer; transition: 0.3s; height: 85px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 12px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .nav-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
    .page-section { display: none; }
    .custom-modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; overflow-y: auto; }
    .custom-modal-content { background: white; margin: 5% auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

    /* --- é»ååˆ†é æ¨£å¼ --- */
    #reader-wrapper { border-radius: 15px; overflow: hidden; display: none; margin-bottom: 15px; border: 4px solid #0d6efd; background: #000; }
    .attendance-scroll-area { height: calc(100vh - 380px); overflow-y: auto; background: #f8f9fa; border-radius: 12px; padding: 10px; border: 1px solid #ddd; }
    #attendanceListBody { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }
    .att-item { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 6px 2px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; height: 75px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .att-item.selected { background-color: #0d6efd !important; color: white !important; }
    .att-item.submitted { background-color: #d1e7dd !important; border-color: #badbcc !important; }
    .att-item.submitted::after { content: "âœ“"; position: absolute; top: 2px; right: 5px; color: #198754; font-weight: 900; }
    .att-name { font-size: 0.85rem; font-weight: bold; }

    /* --- æœƒå‹åˆ†é æ¨£å¼ --- */
    .member-table-container { height: calc(100vh - 250px); overflow: auto; border: 1px solid #dee2e6; border-radius: 8px; background: white; }
    .member-table-container thead th { position: sticky; top: 0; z-index: 10; background-color: #212529 !important; color: white; }
    .member-table-container tbody td:first-child { position: sticky; left: 0; z-index: 5; background-color: #f8f9fa; border-right: 1px solid #dee2e6; }

    /* --- çµ±è¨ˆåˆ†é æ¨£å¼ --- */
    .stat-card { border-radius: 8px; padding: 10px; border: 1px solid #dee2e6; height: 100%; display: flex; flex-direction: column; justify-content: center; }
    .progress { background-color: #e9ecef; height: 10px; border-radius: 5px; }
  </style>
</head>
<body>

<div class="app-container">
  <div id="main-nav">
    <h2 class="fw-bold text-center mt-4 mb-4">â›ª æ•™æœƒç®¡ç†ç³»çµ±</h2>
    <div class="card nav-card text-primary mb-3" onclick="showPage('ATTENDANCE')">ğŸ¤ ä¸»æ—¥é»åç³»çµ±</div>
    <div class="card nav-card text-secondary mb-3" onclick="showPage('MEMBERS')">ğŸ‘¥ æœƒå‹åå–®ç®¡ç†</div>
    <div class="card nav-card text-success mb-3" onclick="showPage('STATS')">ğŸ“Š å‡ºå¸­çµ±è¨ˆæŸ¥è©¢</div>
  </div>

  <div id="content-area" style="display:none;">
    <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goHome()">â† å›ä¸»é¸å–®</button>

    <div id="page-ATTENDANCE" class="page-section">
      <div class="card p-3 shadow-sm border-0 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fw-bold small">ğŸ“· QR Code æƒæå ±åˆ°</span>
          <button id="scanBtn" class="btn btn-sm btn-primary" onclick="toggleScanner()">é–‹å•Ÿç›¸æ©Ÿ</button>
        </div>
        <div id="reader-wrapper"><div id="reader"></div></div>
      </div>
      
      <div class="card p-3 shadow-sm border-0 bg-light">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0 fw-bold">ğŸ¤ é»åè¡¨</h5>
          <div class="badge bg-success" id="presentCountBadge">âœ… å·²å‡ºå¸­ï¼š<span id="presentCount">0</span></div>
        </div>
        <ul class="nav nav-pills nav-fill mb-3 bg-white p-1 rounded border">
          <li class="nav-item"><a class="nav-link active" id="tab-å°èª" onclick="switchType('å°èª')">å°èª</a></li>
          <li class="nav-item"><a class="nav-link" id="tab-è¯èª" onclick="switchType('è¯èª')">è¯èª</a></li>
          <li class="nav-item"><a class="nav-link" id="tab-è¯åˆ" onclick="switchType('è¯åˆ')">è¯åˆ</a></li>
        </ul>
        <div class="attendance-scroll-area mb-3">
          <div id="attendanceListBody"></div>
        </div>
        <div class="row g-2">
          <div class="col-6"><input type="number" id="newFriendsMale" class="form-control" placeholder="æ–°æœ‹å‹(ç”·)"></div>
          <div class="col-6"><input type="number" id="newFriendsFemale" class="form-control" placeholder="æ–°æœ‹å‹(å¥³)"></div>
        </div>
        <button class="btn btn-success w-100 mt-3 fw-bold py-2" onclick="submitAttendance()">ç¢ºèªé€å‡º</button>
      </div>
    </div>

    <div id="page-MEMBERS" class="page-section">
      <div class="d-flex justify-content-between mb-3">
        <input type="text" id="memberSearchInput" class="form-control form-control-sm w-50" placeholder="æœå°‹å§“å..." oninput="filterMembers()">
        <button class="btn btn-primary btn-sm" onclick="openMemberModal()">ï¼‹ æ–°å¢æœƒå‹</button>
      </div>
      <div class="member-table-container shadow-sm">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-dark"><tr><th>å§“å</th><th>æ€§åˆ¥</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="memberTableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="page-STATS" class="page-section">
      <div class="bg-white p-3 rounded border mb-3">
        <div class="btn-group w-100 mb-3">
          <button class="btn btn-outline-primary btn-sm active" id="btnModeRange" onclick="toggleStatMode('range')">å€é–“çµ±è¨ˆ</button>
          <button class="btn btn-outline-primary btn-sm" id="btnModeSingle" onclick="toggleStatMode('single')">å–®æ—¥æª¢è¦–</button>
        </div>
        <div id="rangeInputArea" class="row g-2">
          <div class="col-6"><input type="date" id="statsStart" class="form-control form-control-sm"></div>
          <div class="col-6"><input type="date" id="statsEnd" class="form-control form-control-sm"></div>
        </div>
        <div id="singleInputArea" style="display:none;"><input type="date" id="statsSingleDate" class="form-control form-control-sm"></div>
        <button class="btn btn-primary btn-sm w-100 mt-3" onclick="fetchStatsData()">ğŸ” é–‹å§‹æŸ¥è©¢</button>
      </div>
      <div id="statsResultArea">
          <div class="row g-2 mb-3">
             <div class="col-4"><div class="stat-card bg-white text-center"><small>ç¸½äººæ•¸</small><b id="valMainStat">0</b></div></div>
             <div class="col-4"><div class="stat-card bg-white text-center"><small>åå–®å‡ºå¸­</small><b id="valMemberStat">0</b></div></div>
             <div class="col-4"><div class="stat-card bg-white text-center"><small>æ–°æœ‹å‹</small><b id="valNewFriendStat">0</b></div></div>
          </div>
          <div class="table-responsive border rounded bg-white">
            <table class="table table-sm mb-0"><tbody id="statsTableBody"></tbody></table>
          </div>
      </div>
    </div>

  </div>
</div>

<div id="memberListModal" class="custom-modal-backdrop">
  <div class="custom-modal-content">
    <h5 id="memModalHeader">æœƒå‹è³‡æ–™</h5>
    <input type="hidden" id="editOldName_Mem">
    <input type="text" id="editName_Mem" class="form-control mb-2" placeholder="å§“å">
    <select id="editGender_Mem" class="form-select mb-2"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
    <textarea id="editNote_Mem" class="form-control mb-2" placeholder="å‚™è¨»"></textarea>
    <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="editIsExcluded_Mem"> ä¸åˆ—å…¥çµ±è¨ˆ</div>
    <div class="text-end"><button class="btn btn-light me-2" onclick="closeMemberModal()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="processMemberSave()">å„²å­˜</button></div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  /* --- ğŸš€ æ ¸å¿ƒ API æ©‹æ¨‘ --- */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbw3Tx8_F5WqHpnA266O0QlbYROj0fY6z34AEWf7xzBpbFu36MDrvAuIRJS84dHhIWs4SQ/exec";
  let attUserId = localStorage.getItem('att_uid') || ('User_' + Math.floor(Math.random() * 1000000));
  localStorage.setItem('att_uid', attUserId);

  async function callGAS(action, params = {}) {
    const query = new URLSearchParams({ action, ...params }).toString();
    try {
      const res = await fetch(`${GAS_URL}?${query}`);
      return await res.json();
    } catch (e) { console.error("API Error:", e); return { status: "error", message: "é€£ç·šå¤±æ•—" }; }
  }

  /* --- å°è¦½æ§åˆ¶ --- */
  function showPage(pageId) {
    document.getElementById('main-nav').style.display = 'none';
    document.getElementById('content-area').style.display = 'block';
    document.querySelectorAll('.page-section').forEach(p => p.style.display = 'none');
    document.getElementById('page-' + pageId).style.display = 'block';
    if(pageId === 'ATTENDANCE') initAttendancePage();
    if(pageId === 'MEMBERS') refreshMemberTable();
    if(pageId === 'STATS') initStatsPage();
  }

  function goHome() {
    stopScanning();
    document.getElementById('main-nav').style.display = 'block';
    document.getElementById('content-area').style.display = 'none';
  }

  /* --- ğŸ¤ é»åç³»çµ±é‚è¼¯ --- */
  let currentAttType = 'å°èª';
  async function initAttendancePage() {
    const today = new Date();
    document.getElementById('tab-å°èª').parentElement.parentElement.previousElementSibling.innerText = `ğŸ“… ${today.toLocaleDateString()}`;
    await switchType('å°èª');
  }

  async function switchType(type) {
    currentAttType = type;
    document.querySelectorAll('#page-ATTENDANCE .nav-link').forEach(n => n.classList.remove('active'));
    document.getElementById(`tab-${type}`).classList.add('active');
    const res = await callGAS('getAttendanceList', { type, uid: attUserId });
    if(res.status === "success") renderAttendanceList(res.activeList, res.nfMale, res.nfFemale);
  }

  function renderAttendanceList(list, nm, nf) {
    const body = document.getElementById('attendanceListBody');
    body.innerHTML = list.map(m => `
      <div class="att-item ${m.isSubmitted?'submitted':(m.isChecked?'selected':'')}" onclick="handleCheck('${m.name}', ${!m.isChecked})">
        <div class="att-name">${m.name}</div>
        <small style="color:${m.gender==='ç”·'?'#0d6efd':'#dc3545'}">${m.gender}</small>
      </div>
    `).join('');
    document.getElementById('presentCount').innerText = list.filter(m=>m.isSubmitted).length + nm + nf;
  }

  async function handleCheck(name, state) {
    await callGAS('syncClickToServer', { name, isChecked: state, type: currentAttType, userId: attUserId });
    switchType(currentAttType);
  }

  async function submitAttendance() {
    const checked = document.querySelectorAll('.att-item.selected');
    const list = Array.from(checked).map(c => c.querySelector('.att-name').innerText + "(?)"); // ç°¡åŒ–è™•ç†
    const res = await callGAS('saveAttendance', {
      date: new Date().toLocaleDateString(),
      list: JSON.stringify(list),
      type: currentAttType,
      male: document.getElementById('newFriendsMale').value || 0,
      female: document.getElementById('newFriendsFemale').value || 0
    });
    alert(res.message);
    switchType(currentAttType);
  }

  /* --- ğŸ‘¥ æœƒå‹ç®¡ç†é‚è¼¯ --- */
  async function refreshMemberTable() {
    const data = await callGAS('getAllMembers');
    const tbody = document.getElementById('memberTableBody');
    tbody.innerHTML = data.map(m => `
      <tr>
        <td><b>${m["å§“å"]}</b></td>
        <td>${m["æ€§åˆ¥"]}</td>
        <td><small>${m["å‚™è¨»"] || ''}</small></td>
        <td><button class="btn btn-sm btn-outline-primary" onclick='openMemberModal(${JSON.stringify(m)})'>æ”¹</button></td>
      </tr>
    `).join('');
  }

  function openMemberModal(m = null) {
    document.getElementById('memberListModal').style.display = 'block';
    if(m) {
      document.getElementById('editOldName_Mem').value = m["å§“å"];
      document.getElementById('editName_Mem').value = m["å§“å"];
      document.getElementById('editGender_Mem').value = m["æ€§åˆ¥"];
    } else {
      document.getElementById('editOldName_Mem').value = "";
      document.getElementById('editName_Mem').value = "";
    }
  }
  function closeMemberModal() { document.getElementById('memberListModal').style.display = 'none'; }

  async function processMemberSave() {
    const oldName = document.getElementById('editOldName_Mem').value;
    const newData = { name: document.getElementById('editName_Mem').value, gender: document.getElementById('editGender_Mem').value };
    const action = oldName ? 'updateMember' : 'addMember';
    const res = await callGAS(action, { oldName, data: JSON.stringify(newData) });
    alert(res.message); closeMemberModal(); refreshMemberTable();
  }

  /* --- ğŸ“Š çµ±è¨ˆç³»çµ±é‚è¼¯ --- */
  let currentStatMode = 'range';
  function initStatsPage() {
    const now = new Date().toISOString().split('T')[0];
    document.getElementById('statsStart').value = now;
    document.getElementById('statsEnd').value = now;
    document.getElementById('statsSingleDate').value = now;
  }

  function toggleStatMode(mode) {
    currentStatMode = mode;
    document.getElementById('rangeInputArea').style.display = mode==='range'?'flex':'none';
    document.getElementById('singleInputArea').style.display = mode==='single'?'block':'none';
  }

  async function fetchStatsData() {
    const req = { 
      type: 'å°èª', // é è¨­
      mode: currentStatMode,
      start: document.getElementById('statsStart').value,
      end: document.getElementById('statsEnd').value,
      date: document.getElementById('statsSingleDate').value
    };
    const res = await callGAS('getAttendanceStats', req);
    if(res.status === "success") {
       document.getElementById('valMainStat').innerText = res.data.avgCount || res.data.presentCount;
       document.getElementById('valMemberStat').innerText = res.data.presentCount;
       document.getElementById('valNewFriendStat').innerText = res.data.newFriends;
       // æ¸²æŸ“è¡¨æ ¼åˆ—è¡¨é‚è¼¯...
    }
  }

  /* --- ğŸ“· ç›¸æ©Ÿæ ¸å¿ƒ --- */
  let html5QrCode = null;
  function toggleScanner() {
    const w = document.getElementById('reader-wrapper');
    if(w.style.display === 'none') { w.style.display='block'; startScanning(); }
    else { stopScanning(); w.style.display='none'; }
  }
  function startScanning() {
    html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devs => {
      const id = devs.length > 1 ? devs[devs.length-1].id : devs[0].id;
      html5QrCode.start(id, { fps:10, qrbox:250 }, (txt) => {
        handleCheck(txt.trim(), true);
        if(navigator.vibrate) navigator.vibrate(100);
      });
    });
  }
  function stopScanning() { if(html5QrCode) html5QrCode.stop().then(()=>html5QrCode.clear()); }
</script>
</body>
</html>
