<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ•™æœƒæœäº‹ç®¡ç†ç³»çµ± - å°ˆæ¥­ç‰ˆ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #f4f7f6; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; user-select: none; }
    .card-custom { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    .table-responsive { max-height: 70vh; overflow: auto; border: 1px solid #dee2e6; background: #fff; position: relative; }
    table { border-collapse: separate; border-spacing: 0; width: 100%; }
    thead th { position: sticky; top: 0; background: #212529 !important; color: white; z-index: 10; padding: 10px; text-align: center; border: 1px solid #373b3e; }
    td { border: 1px solid #ddd; padding: 0 !important; height: 38px; min-width: 120px; }
    .grid-input { width: 100%; height: 100%; border: none; background: transparent; padding: 8px; text-align: center; outline: none; font-size: 14px; cursor: cell; }
    /* é¸å–æ•ˆæœ */
    .grid-input.selected { background-color: rgba(13, 110, 253, 0.15) !important; }
    .grid-input.active-cell { box-shadow: inset 0 0 0 2px #0d6efd !important; background: white !important; cursor: text; }
    #globalLoading { position: fixed; top: 20px; right: 20px; background: #ffc107; padding: 10px 20px; border-radius: 8px; font-weight: bold; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  </style>
</head>
<body>

  <div id="globalLoading" class="hidden">â³ ç³»çµ±é€£ç·šä¸­...</div>

  <div class="container-fluid">
    <div id="reportSection" class="card-custom">
      <div class="toolbar">
        <div>
          <h4 id="groupTitle" class="text-primary m-0 d-inline">è¼‰å…¥ä¸­...</h4>
          <span class="ms-3 text-muted small">å¿«æ·éµ: Enter(å®Œæˆä¸¦ä¸‹ç§») / Tab(ä¸‹ç§») / Ctrl+Z(å¾©åŸ)</span>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary" onclick="undo()">â†¶ å¾©åŸ</button>
          <button class="btn btn-sm btn-outline-secondary me-3" onclick="redo()">â†· é‡åš</button>
          <button class="btn btn-primary" onclick="saveData()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
          <button class="btn btn-outline-secondary ms-2" onclick="goToHome()">å›ä¸»é </button>
        </div>
      </div>
      <div class="table-responsive">
        <table>
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbx4268IkgwQm2Es0gjDHLU_U9nKJrRMR1-xzbbtuaq08lePLgAQ2wnDRrCeHdy9jNhh/exec"; 
  const currentId = new URLSearchParams(window.location.search).get('id');
  let activeGroupName = "";
  
  // ç‹€æ…‹ç®¡ç†
  let isMouseDown = false;
  let startCell = {r: 1, c: 0};
  let endCell = {r: 1, c: 0};
  
  // æ­·å²ç´€éŒ„
  let undoStack = [];
  let redoStack = [];

  const showLoading = () => document.getElementById('globalLoading').classList.remove('hidden');
  const hideLoading = () => document.getElementById('globalLoading').classList.add('hidden');

  async function fetchAPI(action, params = {}) {
    let url = new URL(GAS_URL);
    url.searchParams.append('action', action);
    for (let key in params) { url.searchParams.append(key, params[key]); }
    const response = await fetch(url);
    const result = await response.json();
    return result.data;
  }

  window.onload = async () => {
    if (!currentId) return;
    showLoading();
    try {
      const data = await fetchAPI('getPageConfig', { id: currentId });
      renderMatrix(data);
      saveSnapshot();
    } catch (err) { alert("è¼‰å…¥å¤±æ•—"); }
    finally { hideLoading(); }
  };

  function renderMatrix(data) {
    activeGroupName = data.groupName;
    document.getElementById('groupTitle').innerText = data.groupName;
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    thead.innerHTML = `<tr>${data.matrix[0].map(h => `<th>${h}</th>`).join('')}</tr>`;
    
    tbody.innerHTML = data.matrix.slice(1).map((row, rIdx) => {
      const r = rIdx + 1;
      return `<tr>${row.map((cell, cIdx) => `
        <td><input class="grid-input" value="${cell}" readonly data-r="${r}" data-c="${cIdx}"
                   onmousedown="doMouseDown(event)" onmouseenter="doMouseEnter(event)" ondblclick="startEdit(event.target)"></td>
      `).join('')}</tr>`;
    }).join('');
    updateSelection();
  }

  // --- æ­·å²ç´€éŒ„ ---
  function saveSnapshot() {
    const currentData = Array.from(document.querySelectorAll('#tableBody tr')).map(tr => 
      Array.from(tr.querySelectorAll('input')).map(i => i.value)
    );
    undoStack.push(JSON.stringify(currentData));
    if (undoStack.length > 50) undoStack.shift();
    redoStack = [];
  }

  function undo() {
    if (undoStack.length <= 1) return;
    redoStack.push(undoStack.pop());
    applySnapshot(undoStack[undoStack.length - 1]);
  }

  function redo() {
    if (redoStack.length === 0) return;
    const data = redoStack.pop();
    undoStack.push(data);
    applySnapshot(data);
  }

  function applySnapshot(jsonStr) {
    const data = JSON.parse(jsonStr);
    const rows = document.querySelectorAll('#tableBody tr');
    data.forEach((rowData, r) => {
      const inputs = rows[r].querySelectorAll('input');
      rowData.forEach((val, c) => { inputs[c].value = val; });
    });
  }

  // --- é¸å–èˆ‡ç·¨è¼¯é‚è¼¯ ---
  function doMouseDown(e) {
    if (!e.target.readOnly) return; // ç·¨è¼¯ä¸­ä¸é‡ç½®é¸å–
    isMouseDown = true;
    startCell = { r: parseInt(e.target.dataset.r), c: parseInt(e.target.dataset.c) };
    endCell = { ...startCell };
    updateSelection();
  }

  function doMouseEnter(e) {
    if (!isMouseDown) return;
    endCell = { r: parseInt(e.target.dataset.r), c: parseInt(e.target.dataset.c) };
    updateSelection();
  }

  window.onmouseup = () => { isMouseDown = false; };

  function updateSelection() {
    document.querySelectorAll('.grid-input').forEach(el => {
      el.classList.remove('selected', 'active-cell');
      const r = parseInt(el.dataset.r), c = parseInt(el.dataset.c);
      if (r >= Math.min(startCell.r, endCell.r) && r <= Math.max(startCell.r, endCell.r) &&
          c >= Math.min(startCell.c, endCell.c) && c <= Math.max(startCell.c, endCell.c)) {
        el.classList.add('selected');
        if (r === startCell.r && c === startCell.c) el.classList.add('active-cell');
      }
    });
  }

  function startEdit(el) {
    if (!el) return;
    el.readOnly = false;
    el.classList.add('active-cell');
    el.focus();
    // é›¢é–‹ç·¨è¼¯æ™‚å„²å­˜å¿«ç…§ä¸¦é–å®š
    el.onblur = () => { 
      el.readOnly = true; 
      saveSnapshot(); 
    };
  }

  function stopEdit(el) {
    el.readOnly = true;
    el.blur();
  }

  // --- å°ˆæ¥­å¿«æ·éµç›£è½ ---
  document.addEventListener('keydown', (e) => {
    const active = document.activeElement;
    const isEditing = active.classList.contains('grid-input') && !active.readOnly;
    
    // 1. ç·¨è¼¯æ¨¡å¼ä¸‹çš„æŒ‰éµ
    if (isEditing) {
      if (e.key === 'Enter') {
        e.preventDefault();
        stopEdit(active);
        moveFocus(1, 0); // ä¸‹ç§»ä¸€æ ¼
      }
      if (e.key === 'Tab') {
        e.preventDefault();
        stopEdit(active);
        moveFocus(0, e.shiftKey ? -1 : 1); // æ©«ç§»
      }
      return;
    }

    // 2. é¸å–æ¨¡å¼ä¸‹çš„å¿«æ·éµ
    if (!active.classList.contains('grid-input')) return;

    // A. éš¨æ‰“å³å…¥ï¼šæŒ‰å­—æ¯ã€æ•¸å­—éµç«‹å³é–‹é–€
    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
      active.value = ""; // æ¸…ç©ºåŸæœ¬å…§å®¹ï¼Œé–‹å§‹æ–°è¼¸å…¥
      startEdit(active);
      return; 
    }

    // B. æ­·å²ç´€éŒ„
    if (e.ctrlKey && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); return; }
    if (e.ctrlKey && e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); return; }

    // C. Shift é¸å–
    if (e.shiftKey && e.key.startsWith('Arrow')) {
      e.preventDefault();
      const dr = e.key === 'ArrowUp' ? -1 : e.key === 'ArrowDown' ? 1 : 0;
      const dc = e.key === 'ArrowLeft' ? -1 : e.key === 'ArrowRight' ? 1 : 0;
      endCell.r = Math.max(1, Math.min(document.querySelectorAll('#tableBody tr').length, endCell.r + dr));
      endCell.c = Math.max(0, Math.min(document.querySelectorAll('#tableHead th').length - 1, endCell.c + dc));
      updateSelection();
      return;
    }

    // D. æ–¹å‘éµå°èˆª
    if (!e.shiftKey && e.key.startsWith('Arrow')) {
      e.preventDefault();
      const dr = e.key === 'ArrowUp' ? -1 : e.key === 'ArrowDown' ? 1 : 0;
      const dc = e.key === 'ArrowLeft' ? -1 : e.key === 'ArrowRight' ? 1 : 0;
      moveFocus(dr, dc);
      return;
    }

    // E. æ‰¹æ¬¡åˆªé™¤
    if (e.key === 'Delete' || e.key === 'Backspace') {
      saveSnapshot();
      document.querySelectorAll('.grid-input.selected').forEach(el => el.value = "");
      e.preventDefault();
    }
  });

  function moveFocus(dr, dc) {
    const newR = Math.max(1, Math.min(document.querySelectorAll('#tableBody tr').length, startCell.r + dr));
    const newC = Math.max(0, Math.min(document.querySelectorAll('#tableHead th').length - 1, startCell.c + dc));
    startCell = { r: newR, c: newC };
    endCell = { ...startCell };
    updateSelection();
    const target = document.querySelector(`.grid-input[data-r="${newR}"][data-c="${newC}"]`);
    if (target) target.focus();
  }

  async function saveData() {
    showLoading();
    const matrix = [Array.from(document.querySelectorAll('#tableHead th')).map(th => th.innerText)];
    document.querySelectorAll('#tableBody tr').forEach(tr => {
      matrix.push(Array.from(tr.querySelectorAll('input')).map(i => i.value));
    });
    try {
      const response = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: "saveSheetData", data: { groupName: activeGroupName, matrix: matrix } })
      });
      const res = await response.json();
      alert(res.message);
    } catch (e) { alert("å„²å­˜å¤±æ•—"); }
    finally { hideLoading(); }
  }

  function goToHome() { window.location.href = window.location.href.split('?')[0]; }
</script>
</body>
</html>
