<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>æ•™æœƒæœäº‹ç³»çµ±ç®¡ç†</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
      body { background-color: #f4f7f6; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
      .card-custom { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
      .hidden { display: none; }
      .grid-input { width: 100%; border: none; background: transparent; padding: 8px; text-align: center; outline: none; font-size: 14px; }
      .grid-input:focus { background: #e8f0fe; font-weight: bold; }
      td { border: 1px solid #ddd; padding: 0 !important; }
      .table-responsive { max-height: 70vh; overflow: auto; border: 1px solid #dee2e6; }
      thead th { position: sticky; top: 0; background: #212529; color: white; z-index: 5; }
      #globalLoading { position: fixed; top: 20px; right: 20px; background: #ffc107; padding: 10px 20px; border-radius: 8px; font-weight: bold; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    </style>
  </head>
  <body>

    <div id="globalLoading" class="hidden">â³ ç³»çµ±é€£ç·šä¸­...</div>

    <div class="container-fluid">
      
      <div id="adminMain" class="card-custom hidden" style="max-width: 600px;">
        <h3 class="text-center mb-4 text-primary">æ•™æœƒæœäº‹ç³»çµ±ç®¡ç†</h3>
        <div id="groupButtons" class="d-grid gap-2"></div>
        <hr>
        <button class="btn btn-primary w-100" onclick="showSection('createSection')">â• å»ºç«‹æ–°åˆ†é </button>
      </div>

      <div id="createSection" class="card-custom hidden" style="max-width: 600px;">
        <h4>å»ºç«‹æ–°åˆ†é </h4>
        <form id="createGroupForm">
          <div class="mb-3"><input id="newId" class="form-control" placeholder="ID (ä¾‹: worship)" required></div>
          <div class="mb-3"><input id="newName" class="form-control" placeholder="åç¨±" required></div>
          <div class="mb-3"><select id="templateSelect" class="form-select" required></select></div>
          <button type="submit" class="btn btn-success w-100">å»ºç«‹</button>
          <button type="button" class="btn btn-link w-100" onclick="showSection('adminMain')">å–æ¶ˆ</button>
        </form>
      </div>

      <div id="reportSection" class="card-custom hidden">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 id="groupTitle" class="text-primary m-0">è¼‰å…¥ä¸­...</h4>
          <div>
            <button class="btn btn-primary" onclick="saveData()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
            <button class="btn btn-outline-secondary ms-2" onclick="goToHome()">å›ä¸»é </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-sm mb-0">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
      
    </div>

<script>
  // ==========================================
  // âš ï¸ è«‹å°‡ä¸‹æ–¹ç¶²å€æ›¿æ›ç‚ºæ‚¨ GAS éƒ¨ç½²çš„ Web App URL
  // ==========================================
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwVZyD_r_LCawhDwfWNqbiagpiU0GksI_Wm3DcD2SLcYJZ5aO_QpQBiHRUzblJYfkL9/exec"; 
  
const urlParams = new URLSearchParams(window.location.search);
  const currentId = urlParams.get('id');
  let activeGroupName = "";

  const showLoading = () => document.getElementById('globalLoading').classList.remove('hidden');
  const hideLoading = () => document.getElementById('globalLoading').classList.add('hidden');

  // --- API å‘¼å«å·¥å…· ---
  async function fetchAPI(action, params = {}) {
    let url = new URL(GAS_URL);
    url.searchParams.append('action', action);
    for (let key in params) {
      url.searchParams.append(key, params[key]);
    }
    const response = await fetch(url);
    const result = await response.json();
    if (result.status !== 'success') throw new Error(result.message);
    return result.data;
  }

  async function postAPI(action, payload) {
    const response = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: action, data: payload })
    });
    const result = await response.json();
    if (result.status !== 'success') throw new Error(result.message);
    return result;
  }

  window.onload = async () => {
    showLoading();
    try {
      if (!currentId) {
        showSection('adminMain');
        await loadAdminData();
      } else {
        showSection('reportSection');
        const data = await fetchAPI('getPageConfig', { id: currentId });
        renderMatrix(data);
      }
    } catch (err) {
      alert("è¼‰å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
      if(currentId) document.getElementById('groupTitle').innerText = "éŒ¯èª¤: " + err.message;
    } finally {
      hideLoading();
    }
  };

  function renderMatrix(data) {
    activeGroupName = data.groupName;
    document.getElementById('groupTitle').innerText = data.groupName;
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    thead.innerHTML = ""; tbody.innerHTML = "";

    data.matrix.forEach((row, rIdx) => {
      const tr = document.createElement('tr');
      row.forEach((cell, cIdx) => {
        const el = document.createElement(rIdx === 0 ? 'th' : 'td');
        
        // â˜… å¼·åŒ– 1: ç¬¬ä¸€åˆ—ç›´æ¥è®Šç´”æ–‡å­—æ¨™é¡Œï¼Œä¸çµ¦ç·¨è¼¯
        if (rIdx === 0) {
          el.innerText = cell;
          el.style.backgroundColor = '#212529'; // ç¢ºä¿æ·±è‰²èƒŒæ™¯
          el.style.color = 'white';
        } else {
          // å…¶ä»–åˆ—ç”¢ç”Ÿè¼¸å…¥æ¡†
          const input = document.createElement('input');
          input.className = "grid-input";
          input.value = cell;
          
          // ç´€éŒ„åº§æ¨™ï¼Œç‚ºäº†æ–¹å‘éµèˆ‡è²¼ä¸ŠåŠŸèƒ½åšæº–å‚™
          input.dataset.r = rIdx;
          input.dataset.c = cIdx;
          
          el.appendChild(input);
        }
        tr.appendChild(el);
      });
      rIdx === 0 ? thead.appendChild(tr) : tbody.appendChild(tr);
    });
  }

  // â˜… å¼·åŒ– 2: æ–¹å‘éµå°èˆªåŠŸèƒ½
  document.addEventListener('keydown', function(e) {
    if (!e.target.classList.contains('grid-input')) return;
    
    let r = parseInt(e.target.dataset.r);
    let c = parseInt(e.target.dataset.c);
    
    if (e.key === 'ArrowUp') r--;
    else if (e.key === 'ArrowDown') r++;
    else if (e.key === 'ArrowLeft') c--;
    else if (e.key === 'ArrowRight') c++;
    else return; // éæ–¹å‘éµå‰‡ä¸è™•ç†

    // å°‹æ‰¾ç›®æ¨™è¼¸å…¥æ¡†ä¸¦è½‰ç§»ç„¦é»
    let nextInput = document.querySelector(`.grid-input[data-r="${r}"][data-c="${c}"]`);
    if (nextInput) {
      nextInput.focus();
      // åœ¨æ ¼å­å…§å·¦å³ç§»å‹•æ™‚ï¼Œå¦‚æœæœ‰æ–‡å­—ï¼Œå¯ä»¥é¸æ“‡ä¸é˜»æ­¢é è¨­è¡Œç‚ºè®“æ¸¸æ¨™å¯ä»¥ç§»å‹•
      // ä½†å¦‚æœæ˜¯ä¸Šä¸‹ç§»å‹•ï¼Œæˆ‘å€‘å¼·è¿«é¸å–æ•´æ ¼ï¼Œé«”é©—æ›´åƒ Excel
      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
        e.preventDefault(); 
        nextInput.select();
      }
    }
  });

  // â˜… å¼·åŒ– 3: æ™ºæ…§æ‰¹é‡è²¼ä¸ŠåŠŸèƒ½
  document.addEventListener('paste', function(e) {
    if (!e.target.classList.contains('grid-input')) return;
    
    // å–å¾—å‰ªè²¼ç°¿è£¡çš„æ–‡å­—
    let pasteData = (e.clipboardData || window.clipboardData).getData('text');
    
    // å¦‚æœåªæœ‰å–®ç´”ä¸€å€‹è©ï¼ˆæ²’æœ‰æ›è¡Œä¹Ÿæ²’æœ‰ Tabï¼‰ï¼Œå°±ç”¨é è¨­è²¼ä¸Šå°±å¥½
    if (!pasteData.includes('\t') && !pasteData.includes('\n')) return;

    e.preventDefault(); // é˜»æ­¢åŸæœ¬åªè²¼åœ¨åŒä¸€æ ¼çš„è¡Œç‚º

    // Excel è¤‡è£½å‡ºä¾†çš„è³‡æ–™ï¼Œåˆ—èˆ‡åˆ—ç”¨ \n åˆ†éš”ï¼Œæ¬„èˆ‡æ¬„ç”¨ \t åˆ†éš”
    let rows = pasteData.split(/\r?\n/);
    if (rows[rows.length - 1] === "") rows.pop(); // ç§»é™¤ Excel çµå°¾å¤šé¤˜çš„ç©ºè¡Œ

    let startR = parseInt(e.target.dataset.r);
    let startC = parseInt(e.target.dataset.c);

    // ä¾åºå¡«å…¥å„²å­˜æ ¼
    rows.forEach((rowStr, i) => {
      let cells = rowStr.split('\t');
      cells.forEach((cellVal, j) => {
        let targetInput = document.querySelector(`.grid-input[data-r="${startR + i}"][data-c="${startC + j}"]`);
        if (targetInput) {
          targetInput.value = cellVal.trim();
          targetInput.style.backgroundColor = "#e8f0fe"; // çµ¦å€‹è²¼ä¸ŠæˆåŠŸçš„å°æç¤ºè‰²
          setTimeout(() => targetInput.style.backgroundColor = "transparent", 1000);
        }
      });
    });
  });

  async function saveData() {
    const btn = document.querySelector('.btn-primary');
    btn.disabled = true; btn.innerText = "â³...";
    showLoading();
    
    const matrix = [];
    
    // æŠ“å–æ¨™é¡Œåˆ—
    const headRow = [];
    document.querySelectorAll('#tableHead th').forEach(th => headRow.push(th.innerText));
    matrix.push(headRow);

    // æŠ“å–å…§å®¹åˆ—
    document.querySelectorAll('#tableBody tr').forEach(tr => {
      const rowData = [];
      tr.querySelectorAll('input').forEach(i => rowData.push(i.value));
      matrix.push(rowData);
    });

    try {
      const res = await postAPI('saveSheetData', { groupName: activeGroupName, matrix: matrix });
      alert(res.message);
    } catch (err) {
      alert("å„²å­˜éŒ¯èª¤: " + err.message);
    } finally {
      btn.disabled = false; btn.innerText = "ğŸ’¾ å„²å­˜è®Šæ›´";
      hideLoading();
    }
  }

  function showSection(id) {
    document.querySelectorAll('.card-custom').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  function goToHome() { 
    window.location.href = window.location.href.split('?')[0]; 
  }

  async function loadAdminData() {
    try {
      const [groups, templates] = await Promise.all([
        fetchAPI('getGroups'),
        fetchAPI('getTemplates')
      ]);

      const div = document.getElementById('groupButtons');
      const base = window.location.href.split('?')[0];
      div.innerHTML = groups.map(g => `<a href="${base}?id=${g.id}" class="btn btn-outline-primary text-start">â” ${g.name}</a>`).join('');
      
      document.getElementById('templateSelect').innerHTML = '<option value="" disabled selected>é¸æ“‡æ¨¡æ¿</option>' + templates.map(t=>`<option>${t}</option>`).join('');
    } catch (err) {
      alert("è¼‰å…¥é¸å–®å¤±æ•—ï¼š" + err.message);
    }
  }

  document.getElementById('createGroupForm').onsubmit = async function(e) {
    e.preventDefault();
    showLoading();
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;

    try {
      const res = await postAPI('createGroup', {
        id: document.getElementById('newId').value,
        name: document.getElementById('newName').value,
        template: document.getElementById('templateSelect').value
      });
      alert(res.message);
      location.reload();
    } catch (err) {
      alert("å»ºç«‹å¤±æ•—ï¼š" + err.message);
      btn.disabled = false;
      hideLoading();
    }
  };
</script>
  </body>
</html>
