<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ•™æœƒæœäº‹ç³»çµ±ç®¡ç†</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #f4f7f6; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; user-select: none; }
    .card-custom { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    
    /* Excel ç¶²æ ¼å„ªåŒ– */
    .table-responsive { max-height: 70vh; overflow: auto; border: 1px solid #dee2e6; background: #fff; }
    table { border-collapse: separate; border-spacing: 0; width: 100%; }
    thead th { position: sticky; top: 0; background: #212529 !important; color: white; z-index: 10; padding: 10px; text-align: center; border: 1px solid #373b3e; }
    td { border: 1px solid #ddd; padding: 0 !important; height: 38px; min-width: 120px; }
    
    .grid-input { width: 100%; height: 100%; border: none; background: transparent; padding: 8px; text-align: center; outline: none; font-size: 14px; cursor: cell; }
    
    /* â˜… å¤šæ ¼é¸å–è¦–è¦ºæ•ˆæœ */
    .grid-input.selected { background-color: rgba(13, 110, 253, 0.15) !important; }
    .grid-input.active-cell { box-shadow: inset 0 0 0 2px #0d6efd !important; background: white !important; cursor: text; }
    
    #globalLoading { position: fixed; top: 20px; right: 20px; background: #ffc107; padding: 10px 20px; border-radius: 8px; font-weight: bold; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
  </style>
</head>
<body>

  <div id="globalLoading" class="hidden">â³ ç³»çµ±é€£ç·šä¸­...</div>

  <div class="container-fluid">
    
    <div id="adminMain" class="card-custom hidden" style="max-width: 600px;">
      <h3 class="text-center mb-4 text-primary">æ•™æœƒæœäº‹ç³»çµ±ç®¡ç†</h3>
      <div id="groupButtons" class="d-grid gap-2"></div>
      <hr>
      <button class="btn btn-primary w-100" onclick="showSection('createSection')">â• å»ºç«‹æ–°åˆ†é </button>
    </div>

    <div id="createSection" class="card-custom hidden" style="max-width: 600px;">
      <h4>å»ºç«‹æ–°åˆ†é </h4>
      <form id="createGroupForm">
        <div class="mb-3"><input id="newId" class="form-control" placeholder="ID (ä¾‹: worship)" required></div>
        <div class="mb-3"><input id="newName" class="form-control" placeholder="åç¨±" required></div>
        <div class="mb-3"><select id="templateSelect" class="form-select" required></select></div>
        <button type="submit" class="btn btn-success w-100">å»ºç«‹</button>
        <button type="button" class="btn btn-link w-100" onclick="showSection('adminMain')">å–æ¶ˆ</button>
      </form>
    </div>

    <div id="reportSection" class="card-custom hidden">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 id="groupTitle" class="text-primary m-0">è¼‰å…¥ä¸­...</h4>
        <div>
          <button class="btn btn-primary" onclick="saveData()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
          <button class="btn btn-outline-secondary ms-2" onclick="goToHome()">å›ä¸»é </button>
        </div>
      </div>
      <div class="table-responsive">
        <table id="mainTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="mt-2 text-muted small">ğŸ’¡ æç¤ºï¼šæ»‘é¼ æ‹–æ›³å¯å¤šé¸ï½œDelete æ‰¹æ¬¡åˆªé™¤ï½œé›™æ“Šé€²å…¥ç·¨è¼¯ï½œCtrl+V ç¯„åœè²¼ä¸Š</div>
    </div>
    
  </div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbx4268IkgwQm2Es0gjDHLU_U9nKJrRMR1-xzbbtuaq08lePLgAQ2wnDRrCeHdy9jNhh/exec"; 
  const urlParams = new URLSearchParams(window.location.search);
  const currentId = urlParams.get('id');
  let activeGroupName = "";
  
  // é¸å–ç®¡ç†ç‹€æ…‹
  let isMouseDown = false;
  let startCell = {r: null, c: null};
  let endCell = {r: null, c: null};

  const showLoading = () => document.getElementById('globalLoading').classList.remove('hidden');
  const hideLoading = () => document.getElementById('globalLoading').classList.add('hidden');

  async function fetchAPI(action, params = {}) {
    let url = new URL(GAS_URL);
    url.searchParams.append('action', action);
    for (let key in params) { url.searchParams.append(key, params[key]); }
    const response = await fetch(url);
    const result = await response.json();
    if (result.status !== 'success') throw new Error(result.message);
    return result.data;
  }

  async function postAPI(action, payload) {
    const response = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: action, data: payload })
    });
    const result = await response.json();
    if (result.status !== 'success') throw new Error(result.message);
    return result;
  }

  window.onload = async () => {
    showLoading();
    try {
      if (!currentId) {
        showSection('adminMain');
        await loadAdminData();
      } else {
        showSection('reportSection');
        const data = await fetchAPI('getPageConfig', { id: currentId });
        renderMatrix(data);
      }
    } catch (err) { alert("è¼‰å…¥éŒ¯èª¤ï¼š" + err.message); }
    finally { hideLoading(); }
  };

  function renderMatrix(data) {
    activeGroupName = data.groupName;
    document.getElementById('groupTitle').innerText = data.groupName;
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    thead.innerHTML = `<tr>${data.matrix[0].map(h => `<th>${h}</th>`).join('')}</tr>`;
    
    tbody.innerHTML = data.matrix.slice(1).map((row, rIdx) => {
      const realR = rIdx + 1;
      return `<tr>${row.map((cell, cIdx) => `
        <td>
          <input class="grid-input" value="${cell}" readonly 
                 data-r="${realR}" data-c="${cIdx}"
                 onmousedown="doMouseDown(event)" 
                 onmouseenter="doMouseEnter(event)"
                 ondblclick="doDblClick(event)">
        </td>`).join('')}</tr>`;
    }).join('');
  }

  // --- â˜… Excel å¤šæ ¼é¸å–æ ¸å¿ƒé‚è¼¯ ---

  function doMouseDown(e) {
    isMouseDown = true;
    const r = parseInt(e.target.dataset.r);
    const c = parseInt(e.target.dataset.c);
    startCell = {r, c};
    endCell = {r, c};
    clearSelectionStyles();
    e.target.classList.add('selected', 'active-cell');
  }

  function doMouseEnter(e) {
    if (!isMouseDown) return;
    const r = parseInt(e.target.dataset.r);
    const c = parseInt(e.target.dataset.c);
    endCell = {r, c};
    updateSelectionRange();
  }

  window.onmouseup = () => { isMouseDown = false; };

  function updateSelectionRange() {
    clearSelectionStyles();
    const minR = Math.min(startCell.r, endCell.r);
    const maxR = Math.max(startCell.r, endCell.r);
    const minC = Math.min(startCell.c, endCell.c);
    const maxC = Math.max(startCell.c, endCell.c);

    document.querySelectorAll('.grid-input').forEach(el => {
      const r = parseInt(el.dataset.r);
      const c = parseInt(el.dataset.c);
      if (r >= minR && r <= maxR && c >= minC && c <= maxC) {
        el.classList.add('selected');
      }
    });
  }

  function clearSelectionStyles() {
    document.querySelectorAll('.grid-input').forEach(el => {
      el.classList.remove('selected', 'active-cell');
      el.readOnly = true; // æ¢å¾©å”¯è®€ä»¥åˆ©é¸å–
    });
  }

  function doDblClick(e) {
    e.target.readOnly = false;
    e.target.focus();
    e.target.classList.add('active-cell');
  }

  // éµç›¤æ“ä½œ
  document.addEventListener('keydown', (e) => {
    const active = document.activeElement;
    const isEditing = active.classList.contains('grid-input') && !active.readOnly;
    if (isEditing) return; // æ­£åœ¨ç·¨è¼¯æ‰“å­—æ™‚ä¸è§¸ç™¼æ‰¹æ¬¡åŠŸèƒ½

    const selected = document.querySelectorAll('.grid-input.selected');
    
    // æ‰¹æ¬¡åˆªé™¤
    if (e.key === 'Delete' || e.key === 'Backspace') {
      selected.forEach(el => el.value = "");
      e.preventDefault();
    }
    
    // æ–¹å‘éµç§»å‹•
    if (e.key.startsWith('Arrow') && selected.length > 0) {
      let r = startCell.r, c = startCell.c;
      if (e.key === 'ArrowUp') r--; else if (e.key === 'ArrowDown') r++;
      else if (e.key === 'ArrowLeft') c--; else if (e.key === 'ArrowRight') c++;
      
      const next = document.querySelector(`.grid-input[data-r="${r}"][data-c="${c}"]`);
      if (next) {
        e.preventDefault();
        startCell = {r, c}; endCell = {r, c};
        clearSelectionStyles();
        next.classList.add('selected', 'active-cell');
        next.focus();
      }
    }
  });

  // è²¼ä¸ŠåŠŸèƒ½
  document.addEventListener('paste', (e) => {
    const active = document.activeElement;
    if (!active.classList.contains('grid-input')) return;
    const text = (e.clipboardData || window.clipboardData).getData('text');
    if (!text.includes('\t') && !text.includes('\n')) return;
    
    e.preventDefault();
    const rows = text.split(/\r?\n/).filter(line => line.length > 0);
    const startR = parseInt(active.dataset.r), startC = parseInt(active.dataset.c);
    
    rows.forEach((row, i) => {
      row.split('\t').forEach((val, j) => {
        const target = document.querySelector(`.grid-input[data-r="${startR + i}"][data-c="${startC + j}"]`);
        if (target) target.value = val.trim();
      });
    });
  });

  async function saveData() {
    const btn = document.querySelector('.btn-primary');
    btn.disabled = true; showLoading();
    
    const matrix = [Array.from(document.querySelectorAll('#tableHead th')).map(th => th.innerText)];
    document.querySelectorAll('#tableBody tr').forEach(tr => {
      matrix.push(Array.from(tr.querySelectorAll('input')).map(i => i.value));
    });
    
    try {
      const res = await postAPI('saveSheetData', { groupName: activeGroupName, matrix: matrix });
      alert(res.message);
    } catch (err) { alert("å„²å­˜éŒ¯èª¤: " + err.message); }
    finally { btn.disabled = false; hideLoading(); }
  }

  function showSection(id) {
    document.querySelectorAll('.card-custom').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  function goToHome() { window.location.href = window.location.href.split('?')[0]; }

  async function loadAdminData() {
    const [groups, templates] = await Promise.all([fetchAPI('getGroups'), fetchAPI('getTemplates')]);
    const div = document.getElementById('groupButtons');
    div.innerHTML = groups.map(g => `<a href="${window.location.href.split('?')[0]}?id=${g.id}" class="btn btn-outline-primary text-start">â” ${g.name}</a>`).join('');
    document.getElementById('templateSelect').innerHTML = '<option value="" disabled selected>é¸æ“‡æ¨¡æ¿</option>' + templates.map(t=>`<option>${t}</option>`).join('');
  }

  document.getElementById('createGroupForm').onsubmit = async function(e) {
    e.preventDefault(); showLoading();
    try {
      await postAPI('createGroup', {
        id: document.getElementById('newId').value,
        name: document.getElementById('newName').value,
        template: document.getElementById('templateSelect').value
      });
      location.reload();
    } catch (err) { alert(err.message); hideLoading(); }
  };
</script>
</body>
</html>
