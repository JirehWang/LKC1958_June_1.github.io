/* ----------------------------------------------------------------
   ğŸš€ é»åç³»çµ±æ ¸å¿ƒé‚è¼¯ (GitHub API ç‰ˆ)
   ---------------------------------------------------------------- */
let localPendingActions = {}; 
let attUserId = localStorage.getItem('att_uid') || ('User_' + Math.floor(Math.random() * 1000000));
localStorage.setItem('att_uid', attUserId);

let attSyncTimer = null;
let attIsRendering = false; 
let currentAttType = 'å°èª';
let html5QrCode = null; 
let lastClickTime = 0; 
const DOUBLE_CLICK_DELAY = 350;

// --- 1. åˆå§‹åŒ–é»åé é¢ ---
async function initAttendancePage(type) {
  if(!type) type = 'å°èª';
  const today = new Date();
  document.getElementById('todayDateDisplay').innerText = `ğŸ“… ${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()}`;
  await switchType(type);
  startAutoSync(); 
}

// --- 2. åˆ‡æ›é¡åˆ¥ (å°èª/è¯èª/è¯åˆ) ---
async function switchType(type) {
  if (attIsRendering) return; 
  currentAttType = type;
  attIsRendering = true;
  
  // åˆ‡æ› UI ç‹€æ…‹
  document.querySelectorAll('#page-ATTENDANCE .nav-link').forEach(el => el.classList.remove('active'));
  const tab = document.getElementById(`tab-${type}`);
  if(tab) tab.classList.add('active');
  
  const listBody = document.getElementById('attendanceListBody');
  listBody.innerHTML = `<div class="full-width-msg"><div class="spinner-border text-primary mb-3"></div><div class="h6">è®€å– [${type}] åå–®ä¸­...</div></div>`;

  // ğŸš€ æ”¹ç”¨ API å‘¼å«
  const result = await callGAS('getAttendanceList', { type: type, uid: attUserId });
  
  if (result && result.status === "success") {
    let list = result.activeList || [];
    let nfMale = result.nfMale || 0;
    let nfFemale = result.nfFemale || 0;
    renderAttendanceList(list, nfMale, nfFemale);
  } else {
    listBody.innerHTML = `<div class="full-width-msg text-danger">âŒ è®€å–å¤±æ•—: ${result ? result.message : 'é€£ç·šéŒ¯èª¤'}</div>`;
  }
  attIsRendering = false;
}

// --- 3. æ¸²æŸ“åå–® (ä¿æŒåŸæœ‰é‚è¼¯) ---
function renderAttendanceList(data, nfMale = 0, nfFemale = 0) {
  const container = document.getElementById('attendanceListBody');
  container.innerHTML = ''; 

  if (!data || data.length === 0) {
    container.innerHTML = '<div class="full-width-msg p-5 h6">âš ï¸ æŸ¥ç„¡åå–®</div>';
    document.getElementById('presentCount').innerText = '0';
    return;
  }

  const submittedCount = data.filter(m => m.isSubmitted).length;
  document.getElementById('presentCount').innerText = submittedCount + Number(nfMale) + Number(nfFemale);
  document.getElementById('newFriendsMale').value = nfMale;
  document.getElementById('newFriendsFemale').value = nfFemale;

  const now = Date.now();

  data.forEach(m => {
    const label = document.createElement('label');
    label.className = "att-item shadow-sm";
    let isChecked = m.isChecked;
    let isLocked = (m.isChecked && m.operatorId && m.operatorId !== attUserId);
    let isSubmitted = m.isSubmitted;

    if (localPendingActions[m.name] && (now - localPendingActions[m.name].time < 5000)) {
      isChecked = localPendingActions[m.name].state;
      isLocked = false;
    }

    let checkState = isChecked ? "checked" : "";
    let isDisabled = (isSubmitted || isLocked) ? "disabled" : "";
    let statusColor = m.gender === 'ç”·' ? '#007bff' : (m.gender === 'å¥³' ? '#e64980' : '#6c757d');

    if (isSubmitted) {
      label.classList.add('submitted');
      statusColor = '#198754';
      label.onclick = (e) => {
        e.preventDefault();
        const n = new Date().getTime();
        if (n - lastClickTime < DOUBLE_CLICK_DELAY) { confirmRevoke(m.name); lastClickTime = 0; } 
        else { lastClickTime = n; }
      };
    } else if (isLocked) {
      label.classList.add('locked');
    } else if (isChecked) {
      label.classList.add('selected');
      statusColor = '#e9ecef';
    } 

    if (!isSubmitted && !isLocked) {
      label.onclick = function(e) {
        e.preventDefault();
        const cb = this.querySelector('input');
        cb.checked = !cb.checked;
        toggleCardStyle(cb);
      };
    }

    label.innerHTML = `
      <input type="checkbox" value="${m.name}" data-uid="${m.id || ''}" ${checkState} ${isDisabled}>
      <div class="att-name">${m.name}</div>
      <div class="att-info"><b class="gender-text" style="color: ${statusColor};">${m.gender || 'æœªçŸ¥'}</b></div>
    `;
    container.appendChild(label);
  });
}

// --- 4. é»æ“ŠåŒæ­¥ (å³æ™‚å­˜å…¥ SYNC_TEMP) ---
async function toggleCardStyle(checkbox) {
  const isChecked = checkbox.checked;
  const name = checkbox.value;
  
  if (isChecked) checkbox.parentElement.classList.add('selected');
  else checkbox.parentElement.classList.remove('selected');
  
  localPendingActions[name] = { time: Date.now(), state: isChecked };
  
  // ğŸš€ æ”¹ç”¨ API å‘¼å«
  const res = await callGAS('syncClickToServer', { name, isChecked, type: currentAttType, userId: attUserId });
  if (!res || res.status !== "success") {
    checkbox.checked = !isChecked; 
    checkbox.parentElement.classList.toggle('selected');
    delete localPendingActions[name];
  }
}

// --- 5. æ­£å¼æäº¤å‡ºå¸­ç´€éŒ„ ---
async function submitAttendance() {
  const checked = document.querySelectorAll('.att-item.selected input:checked:not([disabled])');
  const maleCount = parseInt(document.getElementById('newFriendsMale').value) || 0;
  const femaleCount = parseInt(document.getElementById('newFriendsFemale').value) || 0;
  
  if (!confirm(`ç¢ºå®šé€å‡ºå·²é¸åå–®åŠ ${maleCount + femaleCount} ä½æ–°æœ‹å‹ï¼Ÿ`)) return;
  
  const presentList = Array.from(checked).map(cb => `${cb.value}(${cb.parentElement.querySelector('.gender-text').innerText})`);
  
  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.innerHTML = 'è™•ç†ä¸­...';

  // ğŸš€ æ”¹ç”¨ API å‘¼å« (æ³¨æ„ï¼šList è¦è½‰æˆå­—ä¸²å‚³é€)
  const res = await callGAS('saveAttendance', {
    date: document.getElementById('todayDateDisplay').innerText.replace('ğŸ“… ',''),
    list: JSON.stringify(presentList),
    type: currentAttType,
    male: maleCount,
    female: femaleCount
  });

  if (res && res.status === "success") {
    alert(res.message);
    switchType(currentAttType);
  }
  btn.disabled = false; btn.innerHTML = 'ç¢ºèªé€å‡º';
}

// --- 6. è‡ªå‹•è¼ªè©¢åŒæ­¥ç‹€æ…‹ ---
async function fetchRemoteStatus() {
  if (attIsRendering || document.getElementById('attSearchInput').value) return;
  
  const res = await callGAS('getQuickSyncData', { type: currentAttType, uid: attUserId });
  if (res && res.status === "success") {
    renderAttendanceList(res.activeList, res.nfMale, res.nfFemale);
  }
}

function startAutoSync() { stopAutoSync(); attSyncTimer = setInterval(fetchRemoteStatus, 5000); }
function stopAutoSync() { if (attSyncTimer) clearInterval(attSyncTimer); }

// --- 7. QR Code æƒæé‚è¼¯ (GitHub å°ˆç”¨) ---
function handleQrCodeResult(scannedText) {
  let found = false;
  const checkboxes = document.querySelectorAll('#attendanceListBody input[type="checkbox"]');
  
  for (let cb of checkboxes) {
    // å„ªå…ˆæ¯”å° data-uid (ç·¨è™Ÿ)ï¼Œå…¶æ¬¡æ¯”å°å§“å
    if ((cb.dataset.uid === scannedText || cb.value === scannedText) && !cb.disabled) {
      if (!cb.checked) {
        cb.checked = true; 
        toggleCardStyle(cb);
        cb.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      if (navigator.vibrate) navigator.vibrate(100); 
      found = true;
      break;
    }
  }
}
