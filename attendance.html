<style>
  /* åˆ—è¡¨é«˜åº¦èª¿æ•´ï¼šè®“åå–®å€åŸŸæœ€å¤§åŒ–ï¼ŒåŒæ™‚ä¿ç•™åº•éƒ¨æŒ‰éˆ•ç©ºé–“ */
  .attendance-scroll-area {
    height: calc(100vh - 260px) !important;
    background: #f8f9fa;
    padding: 12px; 
    overflow-y: auto; 
    border-radius: 12px;
    border: 1px solid #dee2e6;
  }

  /* RWD ç¶²æ ¼ç³»çµ± */
  #attendanceListBody {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(22%, 70px), 1fr)); 
    gap: 8px; 
  }

  /* å¡ç‰‡æ¨£å¼ */
  .att-item {
    background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 4px 2px; 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; height: 75px; transition: all 0.1s; position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    user-select: none; -webkit-tap-highlight-color: transparent;
  }
  .att-item:active { transform: scale(0.96); }
  
  .att-name {
    font-size: 0.85rem; font-weight: bold; text-align: center; line-height: 1.1;
    word-break: break-all; display: -webkit-box; -webkit-line-clamp: 2;
    -webkit-box-orient: vertical; overflow: hidden;
  }
  .att-info { font-size: 0.65rem; margin-top: 1px; }
  
  .att-item input[type="checkbox"] { width: 16px; height: 16px; margin-bottom: 4px; pointer-events: none; }

  /* --- ç‹€æ…‹é¡è‰²æ¨£å¼ --- */
  .att-item.selected { background-color: #0d6efd !important; color: white !important; border-color: #0a58ca; }
  .att-item.selected .att-info, .att-item.selected .gender-text { color: #e9ecef !important; }
  
  .att-item.submitted { background-color: #d1e7dd !important; border-color: #badbcc !important; cursor: pointer; }
  .att-item.submitted .att-name { color: #0f5132 !important; }
  .att-item.submitted::after { content: "âœ“"; position: absolute; top: 2px; right: 5px; color: #198754; font-weight: 900; font-size: 14px; }
  
  .att-item.locked { background-color: #e9ecef !important; border-color: #ced4da !important; cursor: not-allowed !important; opacity: 0.6; }
  .att-item.locked::after { content: "ğŸ”’"; position: absolute; top: 2px; right: 5px; font-size: 10px; opacity: 0.5; }

  .full-width-msg { grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #6c757d; width: 100%; }

  #attendanceAddModal {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.6); z-index:9999; overflow-y: auto;
  }
  .custom-modal-content {
    background: white; margin: 5% auto; padding: 25px; width: 90%;
    max-width: 500px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative; text-align: left;
  }
</style>

<div class="mb-3 bg-white p-2 rounded shadow-sm border">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <span class="fw-bold">ğŸ“· QR Code å¿«é€Ÿå ±åˆ°</span>
    <button id="scanBtn" class="btn btn-sm btn-outline-primary" onclick="toggleScanner()">é–‹å•Ÿç›¸æ©Ÿ</button>
  </div>
  <div id="reader" style="display: none; width: 100%; border-radius: 8px; overflow: hidden;"></div>
</div>

<div class="card p-3 shadow-sm border-0 bg-light">
  
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0 fw-bold text-dark">ğŸ¤ é»åç³»çµ±</h4>
    <div class="d-flex gap-2">
      <div id="presentCountBadge" class="badge bg-success text-white p-2 small shadow-sm d-flex align-items-center">
          âœ… å·²å‡ºå¸­ï¼š<span id="presentCount" class="mx-1">0</span> äºº
      </div>
      <div id="todayDateDisplay" class="badge bg-white text-primary border p-2 small shadow-sm"></div>
    </div>
  </div>

  <ul class="nav nav-pills nav-fill mb-3 bg-white p-1 rounded shadow-sm border">
    <li class="nav-item"><a class="nav-link active" id="tab-å°èª" onclick="switchType('å°èª')">å°èª</a></li>
    <li class="nav-item"><a class="nav-link" id="tab-è¯èª" onclick="switchType('è¯èª')">è¯èª</a></li>
    <li class="nav-item"><a class="nav-link" id="tab-è¯åˆ" onclick="switchType('è¯åˆ')">è¯åˆ</a></li>
  </ul>

  <div class="row g-2 mb-3">
    <div class="col-12">
      <div class="input-group shadow-sm">
        <span class="input-group-text bg-white border-end-0 text-muted">ğŸ”</span>
        <input type="text" id="attSearchInput" class="form-control border-start-0" placeholder="æœå°‹..." oninput="filterAttList()">
        <button class="btn btn-outline-success fw-bold" onclick="openAttendanceAddModal()">â• æ–°å¢</button>
      </div>
    </div>
  </div>

  <div class="attendance-scroll-area">
    <div id="attendanceListBody"></div>
  </div>

  <div class="d-flex align-items-center gap-2 mt-3">
    <div class="d-flex flex-column gap-2" style="width: 170px; flex-shrink: 0;">
      <div class="input-group input-group-sm shadow-sm border rounded overflow-hidden">
        <span class="input-group-text bg-white text-primary border-0 fw-bold small px-2" style="width: 80px;">ğŸ‘¦ æ–°(ç”·)</span>
        <input type="number" id="newFriendsMale" class="form-control border-0 text-center fw-bold px-1" value="0" min="0">
      </div>
      <div class="input-group input-group-sm shadow-sm border rounded overflow-hidden">
        <span class="input-group-text bg-white text-danger border-0 fw-bold small px-2" style="width: 80px;">ğŸ‘§ æ–°(å¥³)</span>
        <input type="number" id="newFriendsFemale" class="form-control border-0 text-center fw-bold px-1" value="0" min="0">
      </div>
    </div>

    <button id="submitBtn" class="btn btn-success btn-lg shadow fw-bold flex-grow-1 py-2 h-100" onclick="submitAttendance()" style="font-size: 1.1rem; min-height: 64px;">
      ç¢ºèªé€å‡º
    </button>
  </div>
</div>

<div id="attendanceAddModal">
  <div class="custom-modal-content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold mb-0 text-dark">æ–°å¢æœƒå‹è³‡æ–™</h5>
      <button type="button" class="btn-close" onclick="closeAttendanceAddModal()"></button>
    </div>
    <hr>
    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label fw-bold small text-muted">å§“å</label>
        <input type="text" id="editName_Att" class="form-control form-control-lg" placeholder="è«‹è¼¸å…¥å§“å">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold small text-muted">æ€§åˆ¥</label>
        <select id="editGender_Att" class="form-select form-select-lg">
          <option value="ç”·">ç”· ğŸ‘¦</option>
          <option value="å¥³">å¥³ ğŸ‘§</option>
        </select>
      </div>
      <div class="col-12">
        <label class="form-label fw-bold small text-muted">å‚™è¨»</label>
        <textarea id="editNote_Att" class="form-control" rows="2" placeholder="é›»è©±ã€åœ°å€æˆ–å…¶ä»–è³‡è¨Š..."></textarea>
      </div>
      <div class="col-12">
        <div class="form-check form-switch mt-2">
          <input class="form-check-input" type="checkbox" id="editIsExcluded_Att">
          <label class="form-check-label fw-bold" for="editIsExcluded_Att">ä¸åˆ—å…¥ä¸»æ—¥å‡ºå¸­ç‡çµ±è¨ˆ</label>
        </div>
      </div>
    </div>
    <div class="text-end mt-4">
      <button class="btn btn-light px-4 me-2" onclick="closeAttendanceAddModal()">å–æ¶ˆ</button>
      <button id="saveNewMemberBtn_Att" class="btn btn-primary px-4 fw-bold" onclick="saveNewMemberFromAttendance()">ç¢ºèªå„²å­˜</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  let localPendingActions = {}; 
  let attUserId = localStorage.getItem('att_uid') || ('User_' + Math.floor(Math.random() * 1000000));
  localStorage.setItem('att_uid', attUserId);
  
  let attSyncTimer = null;
  let attIsRendering = false; 
  let currentAttType = 'å°èª';
  let html5QrCode = null; 
  let lastClickTime = 0; 
  const DOUBLE_CLICK_DELAY = 350; 

  function initAttendancePage(type) {
    if(!type) type = 'å°èª';
    const today = new Date();
    document.getElementById('todayDateDisplay').innerText = `ğŸ“… ${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()}`;
    switchType(type);
    startAutoSync(); 
  }

  function switchType(type) {
    if (attIsRendering) return; 
    currentAttType = type;
    attIsRendering = true;
    
    document.querySelectorAll('#page-ATTENDANCE .nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${type}`).classList.add('active');
    
    const listBody = document.getElementById('attendanceListBody');
    listBody.innerHTML = `<div class="full-width-msg"><div class="spinner-border text-primary mb-3"></div><div class="h6">è®€å– [${type}] åå–®ä¸­...</div></div>`;

    google.script.run
      .withFailureHandler(function(error) {
        listBody.innerHTML = `<div class="full-width-msg text-danger">âŒ è®€å–å¤±æ•—: ${error.message}</div>`;
        attIsRendering = false;
      })
      .withSuccessHandler(function(result) {
        let list = [];
        let nfMale = 0;
        let nfFemale = 0;
        
        if (Array.isArray(result)) { 
           list = result; 
        } else if (result && result.activeList) {
           list = result.activeList;
           nfMale = result.nfMale || 0;
           nfFemale = result.nfFemale || 0;
        }
        
        renderAttendanceList(list, nfMale, nfFemale);
        setTimeout(() => { attIsRendering = false; }, 500);
      })
      .getSmartAttendanceList(type, attUserId);
  }

  // --- 2. æ¸²æŸ“åå–®åˆ—è¡¨ (âœ… å°‡ç·¨è™Ÿæ”¾å…¥ data-uid) ---
  function renderAttendanceList(data, nfMale = 0, nfFemale = 0) {
    const container = document.getElementById('attendanceListBody');
    container.innerHTML = ''; 

    if (!data || data.length === 0) {
      container.innerHTML = '<div class="full-width-msg p-5 h6">âš ï¸ æŸ¥ç„¡åå–®</div>';
      document.getElementById('presentCount').innerText = '0';
      return;
    }

    const submittedCount = data.filter(m => m.isSubmitted).length;
    document.getElementById('presentCount').innerText = submittedCount + Number(nfMale) + Number(nfFemale);
    
    document.getElementById('newFriendsMale').value = nfMale;
    document.getElementById('newFriendsFemale').value = nfFemale;

    const now = Date.now();

    data.forEach(m => {
      const label = document.createElement('label');
      label.className = "att-item shadow-sm";
      let isChecked = m.isChecked;
      let isLocked = (m.isChecked && m.operatorId && m.operatorId !== attUserId);
      let isSubmitted = m.isSubmitted;

      if (localPendingActions[m.name] && (now - localPendingActions[m.name].time < 5000)) {
        isChecked = localPendingActions[m.name].state;
        isLocked = false;
      }

      let checkState = isChecked ? "checked" : "";
      let isDisabled = (isSubmitted || isLocked) ? "disabled" : "";
      let statusColor = m.gender === 'ç”·' ? '#007bff' : (m.gender === 'å¥³' ? '#e64980' : '#6c757d');

      if (isSubmitted) {
        label.classList.add('submitted');
        statusColor = '#198754';
        label.onclick = function(e) {
          e.preventDefault();
          const n = new Date().getTime();
          if (n - lastClickTime < DOUBLE_CLICK_DELAY) { 
              confirmRevoke(m.name); 
              lastClickTime = 0; 
          } else { 
              lastClickTime = n; 
          }
        };
      } else if (isLocked) {
        label.classList.add('locked');
      } else if (isChecked) {
        label.classList.add('selected');
        statusColor = '#e9ecef';
      } 

      if (!isSubmitted && !isLocked) {
        label.onclick = function(e) {
          e.preventDefault();
          const cb = this.querySelector('input');
          cb.checked = !cb.checked;
          toggleCardStyle(cb);
        };
      }

      // âœ… è—å…¥ data-uid
      label.innerHTML = `
        <input type="checkbox" value="${m.name}" data-uid="${m.id || ''}" ${checkState} ${isDisabled}>
        <div class="att-name">${m.name}</div>
        <div class="att-info"><b class="gender-text" style="color: ${statusColor};">${m.gender || 'æœªçŸ¥'}</b></div>
      `;
      container.appendChild(label);
    });
  }

  function toggleCardStyle(checkbox) {
    const isChecked = checkbox.checked;
    const name = checkbox.value;
    
    if (isChecked) checkbox.parentElement.classList.add('selected');
    else checkbox.parentElement.classList.remove('selected');
    
    localPendingActions[name] = { time: Date.now(), state: isChecked };
    
    google.script.run.withFailureHandler(function(err) {
        checkbox.checked = !isChecked; 
        checkbox.parentElement.classList.toggle('selected');
        delete localPendingActions[name];
    }).syncClickToServer(name, isChecked, currentAttType, attUserId);
  }

  function openAttendanceAddModal() {
    document.getElementById('attendanceAddModal').style.display = 'block';
    document.getElementById('editName_Att').value = "";
    document.getElementById('editGender_Att').value = "ç”·";
    document.getElementById('editNote_Att').value = "";
    document.getElementById('editIsExcluded_Att').checked = false;
  }
  
  function closeAttendanceAddModal() { 
    document.getElementById('attendanceAddModal').style.display = 'none'; 
  }

  function saveNewMemberFromAttendance() {
    const btn = document.getElementById('saveNewMemberBtn_Att');
    const newData = {
      name: document.getElementById('editName_Att').value.trim(),
      gender: document.getElementById('editGender_Att').value,
      note: document.getElementById('editNote_Att').value.trim(),
      isExcluded: document.getElementById('editIsExcluded_Att').checked
    };
    
    if (!newData.name) return alert("è«‹è¼¸å…¥å§“åï¼");
    
    btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";
    
    google.script.run.withSuccessHandler(function(msg) {
          btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜";
          if (msg.includes("æˆåŠŸ")) { 
              closeAttendanceAddModal(); 
              setTimeout(() => silentRefreshList(), 600); 
          } else { 
              alert(msg); 
          }
      }).addMember(newData); 
  }

  function silentRefreshList() {
    if (attIsRendering) return;
    attIsRendering = true;
    google.script.run.withSuccessHandler(function(result) {
        let list = [];
        let nfMale = 0, nfFemale = 0;
        if (Array.isArray(result)) list = result;
        else if (result && result.activeList) {
           list = result.activeList;
           nfMale = result.nfMale || 0;
           nfFemale = result.nfFemale || 0;
        }
        renderAttendanceList(list, nfMale, nfFemale);
        attIsRendering = false;
    }).getSmartAttendanceList(currentAttType, attUserId);
  }

  function confirmRevoke(name) {
    if (navigator.vibrate) navigator.vibrate(50);
    if (confirm(`ç¢ºå®šè¦æ’¤éŠ· [${name}] çš„é€å‡ºç´€éŒ„å—ï¼Ÿ`)) { executeRevoke(name); }
  }

  function executeRevoke(name) {
    attIsRendering = true;
    const btn = document.getElementById('submitBtn');
    const originalText = "ç¢ºèªé€å‡º";
    btn.disabled = true; btn.innerHTML = 'æ­£åœ¨æ’¤éŠ·...';
    
    google.script.run.withSuccessHandler(function(msg) {
        if (msg === "OK") { 
            localPendingActions[name] = { time: Date.now(), state: true }; 
            alert("âœ… æ’¤éŠ·æˆåŠŸï¼"); 
        } else { 
            alert(msg); 
        }
        btn.disabled = false; btn.innerHTML = originalText;
        attIsRendering = false; 
        switchType(currentAttType); 
    }).revokeAttendance(name, currentAttType, attUserId);
  }

  function fetchRemoteStatus() {
    if (attIsRendering || document.getElementById('attSearchInput').value) return;
    
    google.script.run.withSuccessHandler(function(data) {
        if (!data || attIsRendering) return;
        
        const activeList = Array.isArray(data) ? data : (data.activeList || []);
        const nfMale = Array.isArray(data) ? 0 : (data.nfMale || 0);
        const nfFemale = Array.isArray(data) ? 0 : (data.nfFemale || 0);
        const now = Date.now();
        const container = document.getElementById('attendanceListBody');
        
        activeList.forEach(m => {
           const checkbox = container.querySelector(`input[value="${m.name}"]`);
           if (!checkbox) return;
           const card = checkbox.parentElement;
           
           if (localPendingActions[m.name] && (now - localPendingActions[m.name].time < 5000)) return;
           
           if (m.isSubmitted) {
             if (!card.classList.contains('submitted')) {
                card.className = "att-item shadow-sm submitted";
                checkbox.checked = true; checkbox.disabled = true;
                card.onclick = function(e) { e.preventDefault(); 
                  const n = new Date().getTime();
                  if (n - lastClickTime < DOUBLE_CLICK_DELAY) { confirmRevoke(m.name); lastClickTime = 0; } else { lastClickTime = n; }
                };
             }
           } else if (m.isChecked) {
             checkbox.checked = true;
             if (m.operatorId && m.operatorId !== attUserId) {
               card.className = "att-item shadow-sm locked"; checkbox.disabled = true; card.onclick = null;
             } else {
               card.className = "att-item shadow-sm selected"; checkbox.disabled = false;
               card.onclick = function(e) { e.preventDefault(); const cb=this.querySelector('input'); cb.checked=!cb.checked; toggleCardStyle(cb); };
             }
           } else {
             card.className = "att-item shadow-sm"; checkbox.checked = false; checkbox.disabled = false;
             card.onclick = function(e) { e.preventDefault(); const cb = this.querySelector('input'); cb.checked = !cb.checked; toggleCardStyle(cb); };
           }
        });
        
        const submittedCards = container.querySelectorAll('.att-item.submitted').length;
        document.getElementById('presentCount').innerText = submittedCards + Number(nfMale) + Number(nfFemale);
        
    }).getQuickSyncData(currentAttType, attUserId);
  }

  function startAutoSync() { stopAutoSync(); attSyncTimer = setInterval(fetchRemoteStatus, 4000); }
  function stopAutoSync() { if (attSyncTimer) clearInterval(attSyncTimer); }

  function submitAttendance() {
    const checked = document.querySelectorAll('.att-item.selected input:checked:not([disabled])');
    const maleCount = parseInt(document.getElementById('newFriendsMale').value) || 0;
    const femaleCount = parseInt(document.getElementById('newFriendsFemale').value) || 0;
    const totalNf = maleCount + femaleCount;
    
    if (checked.length === 0 && totalNf === 0) {
        if (!confirm("ç›®å‰æ²’æœ‰å‹¾é¸ä»»ä½•æ–°åå–®ï¼Œæ–°æœ‹å‹ä¹Ÿæ˜¯ 0 äººã€‚\nç¢ºå®šè¦åŸ·è¡Œé€å‡ºå—ï¼Ÿ(é€™å°‡æœƒæŠŠæ–°æœ‹å‹æ•¸é‡æ›´æ–°ç‚º 0)")) return;
    } else {
        if (!confirm(`ç¢ºå®šé€å‡ºå·²é¸åå–®åŠ ${totalNf} ä½æ–°æœ‹å‹ (ç”·:${maleCount}, å¥³:${femaleCount})ï¼Ÿ`)) return;
    }
    
    const presentList = Array.from(checked).map(cb => `${cb.value}(${cb.parentElement.querySelector('.gender-text').innerText})`);
    
    const btn = document.getElementById('submitBtn');
    const originalText = "ç¢ºèªé€å‡º";
    btn.disabled = true; attIsRendering = true; 
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> è™•ç†ä¸­...';
    
    google.script.run.withSuccessHandler(function(msg) {
        alert(msg); 
        btn.disabled = false; btn.innerHTML = originalText; 
        attIsRendering = false; 
        switchType(currentAttType); 
      }).withFailureHandler(function(err) {
        btn.disabled = false; btn.innerHTML = originalText; attIsRendering = false;
      }).saveAttendance(
          document.getElementById('todayDateDisplay').innerText.replace('ğŸ“… ',''), 
          presentList, 
          currentAttType, 
          maleCount,  
          femaleCount 
      );
  }

  function filterAttList() {
    const kw = document.getElementById('attSearchInput').value.trim().toLowerCase();
    document.querySelectorAll('label.att-item').forEach(item => {
      const name = item.querySelector('.att-name').innerText.trim().toLowerCase();
      item.style.display = (kw === "" || name.includes(kw)) ? 'flex' : 'none';
    });
  }

  // --- 10. QR Code æƒæ (âœ… å‡ç´šæ¯”å°é‚è¼¯) ---
  function toggleScanner() {
    const readerElem = document.getElementById('reader');
    const btn = document.getElementById('scanBtn');
    if (readerElem.style.display === 'none') {
      readerElem.style.display = 'block'; btn.innerText = 'é—œé–‰ç›¸æ©Ÿ';
      btn.classList.replace('btn-outline-primary', 'btn-outline-danger');
      startScanning();
    } else { 
      stopScanning(); 
      readerElem.style.display = 'none'; 
      btn.innerText = 'é–‹å•Ÿç›¸æ©Ÿ'; 
      btn.classList.replace('btn-outline-danger', 'btn-outline-primary'); 
    }
  }

function startScanning() {
    html5QrCode = new Html5Qrcode("reader");
    
    // 1. å…ˆå‘è¨­å‚™è©¢å•ï¼šã€Œä½ æœ‰å¹¾é¡†é¡é ­ï¼Ÿã€
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length > 0) {
        
        // 2. åˆ¤æ–·é‚è¼¯ï¼š
        // å¦‚æœæœ‰å¤šé¡†é¡é ­(æ‰‹æ©Ÿ)ï¼Œé€šå¸¸æœ€å¾Œä¸€é¡†æ˜¯å¾Œé¡é ­ -> devices[devices.length - 1]
        // å¦‚æœåªæœ‰ä¸€é¡†é¡é ­(ç­†é›» Webcam) -> devices[0]
        let cameraId = devices.length > 1 ? devices[devices.length - 1].id : devices[0].id;
        
        // 3. å•Ÿå‹•é¸å®šçš„ç›¸æ©Ÿ
        html5QrCode.start(
          cameraId, 
          { fps: 10, qrbox: { width: 250, height: 250 } }, 
          (decodedText) => handleQrCodeResult(decodedText.trim())
        ).catch(err => {
          alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•— (è¢«ç€è¦½å™¨é˜»æ“‹)ã€‚\n\nğŸ‘‰ åœ¨é›»è…¦é–‹ç™¼æ™‚ï¼Œè«‹ç›´æ¥ä½¿ç”¨æ—é‚Šç¶ è‰²çš„ã€ğŸ“¸ æ‹ç…§æƒæã€‘ä¸Šå‚³åœ–ç‰‡ä¾†æ¸¬è©¦ï¼\nè©³ç´°éŒ¯èª¤: " + err);
          toggleScanner();
        });
        
      } else {
        alert("æ‰¾ä¸åˆ°ä»»ä½•æ”å½±æ©Ÿè¨­å‚™ï¼");
        toggleScanner();
      }
    }).catch(err => {
      alert("ç„¡æ³•å–å¾—ç›¸æ©Ÿåˆ—è¡¨ï¼Œæ¬Šé™é­æ‹’ã€‚\néŒ¯èª¤è¨Šæ¯ï¼š" + err);
      toggleScanner();
    });
  }

  function stopScanning() { 
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => html5QrCode.clear()); 
    }
  }

  // âœ… æ–°çš„æƒæè™•ç†é‚è¼¯ï¼šå…ˆæ‰¾ç·¨è™Ÿï¼Œæ‰¾ä¸åˆ°å†æ‰¾å§“å
  function handleQrCodeResult(scannedText) {
    let found = false;
    const checkboxes = document.querySelectorAll('#attendanceListBody input[type="checkbox"]');

    // 1. å„ªå…ˆæ¯”å°ï¼šè—åœ¨èƒŒå¾Œçš„ã€Œç·¨è™Ÿã€(data-uid)
    for (let cb of checkboxes) {
      if (cb.dataset.uid === scannedText && !cb.disabled) {
        if (!cb.checked) {
          cb.checked = true; 
          toggleCardStyle(cb);
          cb.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        if (navigator.vibrate) navigator.vibrate(100); 
        found = true;
        break;
      }
    }
    
    // 2. å‘ä¸‹ç›¸å®¹ï¼šå¦‚æœæƒå‡ºä¾†çš„ä¸æ˜¯ç·¨è™Ÿï¼Œå°±ç•¶ä½œæ˜¯ã€Œå§“åã€ä¾†æ¯”å°
    if (!found) {
      for (let cb of checkboxes) {
        if (cb.value === scannedText && !cb.disabled) {
          if (!cb.checked) {
            cb.checked = true; 
            toggleCardStyle(cb);
            cb.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          if (navigator.vibrate) navigator.vibrate(100);
          found = true;
          break;
        }
      }
    }

    if (!found) {
      console.log("æ‰¾ä¸åˆ°å°æ‡‰çš„ç·¨è™Ÿæˆ–å§“å: " + scannedText);
    }
  }
</script>
